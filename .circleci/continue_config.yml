version: 2.1

parameters:
  role_arn:
    type: string
    default: "arn:aws:iam::313078327096:role/circleci-oidc-role"
    description: "Optional: role ARN to assume. If empty, the job will error and ask you to pass one."
  deploy-terraform:
    type: boolean
    default: false

orbs:
  terraform: circleci/terraform@3.7.0

executors:
  python-executor:
    docker:
      - image: cimg/python:3.10

anchors:
  deployment-branch-condition: &deployment-branch-condition
    filters:
      branches:
        only: main

jobs:
  test:
    executor: python-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - poetry-cache-v3-{{ checksum "poetry.lock" }}
            - poetry-cache-v3-
      - run:
          name: Setup venv (if not present) and install deps
          command: |
            set -euo pipefail
            # create venv if missing and install via poetry or pip
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
              . .venv/bin/activate
              python3 -m pip install --upgrade pip
              if [ -f "poetry.lock" ] || command -v poetry >/dev/null 2>&1; then
                pip install poetry || true
                poetry install --no-interaction --no-ansi || true
              else
                pip install -r requirements.txt || true
              fi
            fi
            . .venv/bin/activate
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            . .venv/bin/activate
            pytest -q

  lint:
    executor: python-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - poetry-cache-v3-{{ checksum "poetry.lock" }}
            - poetry-cache-v3-
      - run:
          name: Setup venv (if not present) and install linters
          command: |
            set -euo pipefail
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
              . .venv/bin/activate
              python3 -m pip install --upgrade pip
              pip install black flake8 || true
            fi
            . .venv/bin/activate
      - run:
          name: Lint code (Black + Flake8)
          command: |
            set -euo pipefail
            . .venv/bin/activate
            black --check src tests
            flake8 src tests

  assume-role-and-terraform:
    docker:
      - image: cimg/python:3.10
    parameters:
      role_arn:
        type: string
        default: ""
        description: "AWS role ARN to assume via OIDC (required)"
    steps:
      - checkout

      - run:
          name: Install AWS CLI & Terraform (simple, reliable)
          command: |
            set -euo pipefail

            # Ensure pip and awscli present
            python3 -m pip install --upgrade pip awscli
            aws --version

            # install terraform (binary zip)
            TERRAFORM_VERSION="1.9.7"
            TMPDIR=$(mktemp -d)
            pushd "$TMPDIR"
            curl -fsSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
            unzip terraform.zip
            sudo mv terraform /usr/local/bin/terraform
            sudo chmod +x /usr/local/bin/terraform
            popd
            rm -rf "$TMPDIR"

            terraform version

      - run:
          name: Assume AWS Role via OIDC and deploy Terraform
          command: |
            set -euo pipefail

            if [ -z "<< parameters.role_arn >>" ]; then
              echo "ERROR: role_arn parameter is empty."
              exit 1
            fi

            if [ -z "${CIRCLE_OIDC_TOKEN:-}" ]; then
              echo "ERROR: CIRCLE_OIDC_TOKEN not present. Enable OIDC in CircleCI project settings."
              exit 1
            fi

            ROLE_ARN="<< parameters.role_arn >>"
            SESSION_NAME="circleci-oidc-$(date +%s)"
            echo "Assuming role: ${ROLE_ARN}"

            CREDS_JSON=$(aws sts assume-role-with-web-identity \
              --role-arn "${ROLE_ARN}" \
              --role-session-name "${SESSION_NAME}" \
              --web-identity-token "${CIRCLE_OIDC_TOKEN}" \
              --duration-seconds 900)

            export AWS_ACCESS_KEY_ID=$(echo "$CREDS_JSON" | python3 -c 'import sys,json; print(json.load(sys.stdin)["Credentials"]["AccessKeyId"])')
            export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS_JSON" | python3 -c 'import sys,json; print(json.load(sys.stdin)["Credentials"]["SecretAccessKey"])')
            export AWS_SESSION_TOKEN=$(echo "$CREDS_JSON" | python3 -c 'import sys,json; print(json.load(sys.stdin)["Credentials"]["SessionToken"])')
            aws sts get-caller-identity

            if [ "<< pipeline.parameters.deploy-terraform >>" = "true" ]; then
              echo "ðŸš€ Deploying infra/circleci-oidc..."
              if [ -d "infra/circleci-oidc" ]; then
                cd infra/circleci-oidc
                terraform init -input=false
                terraform plan -input=false -out=tfplan || true
                terraform apply -auto-approve tfplan || true
                echo "circleci-oidc deployment complete"
                cd ../
              else
                echo "infra/circleci-oidc directory not found; skipping."
              fi

              if [ -d "./infra" ]; then
                echo "ðŸš€ Deploying main infra..."
                cd infra
                terraform init -input=false
                terraform plan -input=false -out=tfplan || true
                terraform apply -auto-approve tfplan || true
                echo "Main infra deployment complete"
                cd ../
              else
                echo "infra directory not found; skipping main infra deployment."
              fi
            else
              echo "Skipping terraform deploy because pipeline parameter 'deploy-terraform' is false."
            fi

            unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN || true
            echo "ðŸ§¹ Temporary AWS credentials cleared."

workflows:
  version: 2
  main-pipeline:
    jobs:
      - test:
          name: unit-test
          <<: *deployment-branch-condition
      - lint:
          name: python-lint
          requires:
            - unit-test
          <<: *deployment-branch-condition
      - assume-role-and-terraform:
          name: tf-deploy
          role_arn: << pipeline.parameters.role_arn >>
          requires:
            - python-lint
          <<: *deployment-branch-condition
